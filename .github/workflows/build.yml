# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: build
on:
  merge_group: {}
  pull_request: {}
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      self-mutation-needed: ${{ steps.self-mutation.outputs.needed }}
    env:
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository }}
          lfs: true
          ref: ${{ github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          cache: yarn
      - name: Cache build outputs
        if: github.event_name == 'pull_request'
        uses: actions/cache@v3
        with:
          key: build-outputs-${{ hashFiles('tsconfig.json', 'build-tools/**/*.ts', 'src/**/*.ts', 'package.json', 'yarn.lock') }}
          path: |-
            tsconfig.tsbuildinfo
            lib/**/*
          restore-keys: build-outputs-
      - name: Install dependencies
        run: yarn install --check-files
      - name: Compile
        run: npx projen && npx projen pre-compile && npx projen compile && npx projen post-compile
      - name: Test
        run: npx projen test
      - name: Find mutations
        id: self-mutation
        run: |-
          git add .
          git diff --cached --patch --exit-code > .repo.patch || echo "needed=true" >> $GITHUB_OUTPUT
      - name: Upload patch
        if: steps.self-mutation.outputs.needed
        uses: actions/upload-artifact@v3
        with:
          name: .repo.patch
          path: .repo.patch
      - name: Fail if self-mutation is needed
        if: steps.self-mutation.outputs.needed
        run: |-
          echo "::error::Files were changed during build (see build log). If this was triggered from a fork, you will need to update your branch."
          cat .repo.patch
          exit 1
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-output
          path: |-
            ${{ github.workspace }}
            ${{ github.workspace }}/dist/private
            !${{ github.workspace }}/node_modules
            !${{ github.workspace }}/fixtures/node_modules
  self-mutation:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CI: "true"
    if: always() && (github.event_name == 'pull_request') && needs.build.outputs.self-mutation-needed && (github.event.pull_request.head.repo.full_name == github.repository)
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.PROJEN_GITHUB_TOKEN }}
      - name: Download patch
        uses: actions/download-artifact@v3
        with:
          name: .repo.patch
          path: ${{ runner.temp }}
      - name: Apply patch
        run: '[ -s ${{ runner.temp }}/.repo.patch ] && git apply ${{ runner.temp }}/.repo.patch || echo "Empty patch. Skipping."'
      - name: Set git identity
        run: |-
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Push changes
        run: |-
          git add .
          git commit -s -m "chore: self-mutation"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
  matrix-test:
    name: test (node ${{ matrix.node-version }})
    needs: build
    runs-on: ubuntu-latest
    permissions: {}
    env:
      CI: "true"
    if: success()
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: ${{ github.workspace }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: yarn
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Re-run post-compile
        run: npx projen post-compile
      - name: Test
        run: npx projen test
      - name: Assert clean working directory
        run: git diff --cached --exit-code
    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 14.x
          - 16.x
          - 18.x
          - 19.x
  package:
    name: package
    needs: build
    runs-on: ubuntu-latest
    permissions: {}
    env:
      CI: "true"
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output
          path: ${{ github.workspace }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 14.18.0
          cache: yarn
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Package
        run: npx projen package
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: release-package
          path: ${{ github.workspace }}/dist
  install-test:
    name: Install Test (${{ matrix.runs-on }} | node ${{ matrix.node-version }} | ${{ matrix.package-manager }})
    needs: package
    runs-on: ${{ matrix.runs-on }}
    permissions: {}
    env:
      CI: "true"
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: release-package
          path: ${{ runner.temp }}/release-package
      - name: Install from tarball (npm)
        if: runner.os != 'Windows' && matrix.package-manager == 'npm'
        run: |-
          npm init -y
          npm install ${{ runner.temp }}/release-package/js/jsii-*.tgz
      - name: Install from tarball (yarn)
        if: runner.os != 'Windows' && matrix.package-manager == 'yarn'
        run: |-
          yarn init -y
          yarn add ${{ runner.temp }}/release-package/js/jsii-*.tgz
      - name: Install from tarball (Windows, npm)
        if: runner.os == 'Windows' && matrix.package-manager == 'npm'
        run: |-
          npm init -y
          $TARBALL = Get-ChildItem -Path "${{ runner.temp }}/release-package/js/jsii-*.tgz"
          npm install $TARBALL
      - name: Install from tarball (Windows, yarn)
        if: runner.os == 'Windows' && matrix.package-manager == 'yarn'
        run: |-
          yarn init -y
          $TARBALL = Get-ChildItem -Path "${{ runner.temp }}/release-package/js/jsii-*.tgz"
          yarn add $TARBALL
      - name: Simple command
        run: ./node_modules/.bin/jsii --version
    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 14.x
          - 16.x
          - 18.x
          - 19.x
        package-manager:
          - npm
          - yarn
        runs-on:
          - ubuntu-latest
          - windows-latest
          - macos-latest
  pacmak-test:
    name: Pacmak Test
    needs: package
    runs-on: ubuntu-latest
    permissions: {}
    env:
      CI: "true"
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with: {}
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: release-package
          path: ${{ runner.temp }}/release-package
      - name: Install from tarball
        run: |-
          npm init -y
          npm install jsii-pacmak@1.x ${{ runner.temp }}/release-package/private/*.tgz
          npm ls --depth=0
          ./node_modules/.bin/jsii-pacmak --version
      - name: Run jsii-pacmak
        run: ./node_modules/.bin/jsii-pacmak --verbose --recurse ./node_modules/jsii-calc
  integ-clear:
    name: Integration Tests
    needs:
      - install-test
      - pacmak-test
    runs-on: ubuntu-latest
    permissions: {}
    env:
      CI: "true"
    steps:
      - name: Done
        run: echo OK
  benchmark:
    name: Benchmark (${{ matrix.compiler }})
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      jsii: ${{ steps.run.outputs.jsii }}
      tsc: ${{ steps.run.outputs.tsc }}
    env:
      CI: "true"
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with: {}
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: build-output
      - name: Install dependencies
        run: yarn install --check-files
      - name: Benchmark
        id: run
        run: |-
          RESULT=$(yarn test:benchmark --silent --compiler=${{ matrix.compiler }})
          echo "${{ matrix.compiler }}=${RESULT}" >> $GITHUB_OUTPUT
    strategy:
      matrix:
        compiler:
          - jsii
          - tsc
  benchmark_summary:
    name: Benchmark Summary
    needs: benchmark
    runs-on: ubuntu-latest
    permissions: {}
    env:
      CI: "true"
    steps:
      - name: Output Summary
        run: |-
          node <<(EOF)
          const results = {
            jsii: ${{ needs.benchmark.outputs.jsii }},
            tsc: ${{ needs.benchmark.outputs.tsc }},
          };
          const delta = (results.jsii.time - results.tsc.time) / results.tsc.time;
          console.log(`Time for jsii: ${results.jsii.time} ms`);
          console.log(`Time for tsc:  ${results.tsc.time} ms`);
          console.log(`Slowdown:      ${(100 * delta).toFixed(1)}%`);
          EOF
